# Guide Alembic pour JDRuwa

## üöÄ Introduction

Alembic est maintenant configur√© dans votre projet JDRuwa pour g√©rer les migrations de base de donn√©es de fa√ßon professionnelle et versionn√©e.

## üìÅ Structure des fichiers

```
JDRuwa/
‚îú‚îÄ‚îÄ alembic/                    # Dossier Alembic
‚îÇ   ‚îú‚îÄ‚îÄ env.py                  # Configuration environnement (modifi√© pour votre projet)
‚îÇ   ‚îú‚îÄ‚îÄ script.py.mako          # Template pour nouvelles migrations
‚îÇ   ‚îî‚îÄ‚îÄ versions/               # Fichiers de migration
‚îÇ       ‚îú‚îÄ‚îÄ 2025_10_19_1639-6b516408398c_initial_migration_create_users_table.py
‚îÇ       ‚îî‚îÄ‚îÄ 2025_10_19_1640-62c8ad7f8c79_add_index_on_users_created_at.py
‚îú‚îÄ‚îÄ alembic.ini                 # Configuration Alembic (modifi√©)
‚îî‚îÄ‚îÄ alembic_helpers.py          # Scripts d'aide pour les migrations
```

## ‚öôÔ∏è Configuration

### Variables d'environnement requises

Alembic utilise automatiquement votre configuration existante depuis `app/core/config.py` :

```bash
# .env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=jdruwa
DB_USER=your_user
DB_PASSWORD=your_password
```

### Modifications apport√©es

1. **alembic.ini** : Comment√© l'URL statique, ajout√© format de noms de fichiers avec timestamp
2. **alembic/env.py** : Configur√© pour utiliser vos mod√®les SQLAlchemy et votre configuration de DB

## üõ†Ô∏è Commandes principales

### Commandes de base

```bash
# Cr√©er une nouvelle migration automatique (d√©tecte les changements de mod√®les)
poetry run alembic revision --autogenerate -m "Description de la migration"

# Cr√©er une migration manuelle (vide)
poetry run alembic revision -m "Description de la migration"

# Appliquer toutes les migrations en attente
poetry run alembic upgrade head

# Revenir √† la migration pr√©c√©dente
poetry run alembic downgrade -1

# Voir l'√©tat actuel
poetry run alembic current

# Voir l'historique des migrations
poetry run alembic history --verbose
```

### Script d'aide simplifi√©

Utilisez `alembic_helpers.py` pour des commandes plus simples :

```bash
# V√©rifier l'√©tat des migrations
python alembic_helpers.py check

# Appliquer toutes les migrations
python alembic_helpers.py upgrade

# Revenir en arri√®re
python alembic_helpers.py downgrade

# Cr√©er une nouvelle migration (interactif)
python alembic_helpers.py create
```

## üìù Workflow de d√©veloppement

### 1. Modifier un mod√®le

```python
# app/db/models/user.py
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), unique=True, nullable=False, index=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    hashed_password = Column(String(255), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # ‚ú® Nouveau champ ajout√©
    last_login = Column(DateTime(timezone=True), nullable=True)
```

### 2. G√©n√©rer la migration

```bash
poetry run alembic revision --autogenerate -m "Add last_login field to users"
```

### 3. V√©rifier la migration g√©n√©r√©e

```python
# alembic/versions/2025_10_19_xxxx_add_last_login_field_to_users.py
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('last_login', sa.DateTime(timezone=True), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'last_login')
    # ### end Alembic commands ###
```

### 4. Appliquer la migration

```bash
poetry run alembic upgrade head
```

## üîß Types de migrations courantes

### Ajouter une colonne

```python
def upgrade() -> None:
    op.add_column('users', sa.Column('phone', sa.String(20), nullable=True))

def downgrade() -> None:
    op.drop_column('users', 'phone')
```

### Cr√©er un index

```python
def upgrade() -> None:
    op.create_index('ix_users_email_username', 'users', ['email', 'username'])

def downgrade() -> None:
    op.drop_index('ix_users_email_username', table_name='users')
```

### Modifier une colonne

```python
def upgrade() -> None:
    op.alter_column('users', 'username',
                    existing_type=sa.VARCHAR(length=50),
                    type_=sa.VARCHAR(length=100),
                    existing_nullable=False)

def downgrade() -> None:
    op.alter_column('users', 'username',
                    existing_type=sa.VARCHAR(length=100),
                    type_=sa.VARCHAR(length=50),
                    existing_nullable=False)
```

### Cr√©er une nouvelle table

```python
def upgrade() -> None:
    op.create_table('posts',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('title', sa.String(200), nullable=False),
        sa.Column('content', sa.Text(), nullable=True),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_posts_id'), 'posts', ['id'])

def downgrade() -> None:
    op.drop_index(op.f('ix_posts_id'), table_name='posts')
    op.drop_table('posts')
```

## ‚ö†Ô∏è Bonnes pratiques

### 1. Toujours v√©rifier avant d'appliquer

```bash
# Voir ce qui va √™tre appliqu√©
poetry run alembic upgrade head --sql

# Voir l'√©tat actuel
poetry run alembic current
```

### 2. Tester les rollbacks

```bash
# Appliquer la migration
poetry run alembic upgrade head

# Tester le rollback
poetry run alembic downgrade -1

# Remettre la migration
poetry run alembic upgrade head
```

### 3. Sauvegarde avant migration en production

```bash
# Faire un dump de la DB avant migration critique
pg_dump jdruwa > backup_before_migration.sql
```

### 4. Migrations de donn√©es

Pour des migrations complexes avec transformation de donn√©es :

```python
from alembic import op
import sqlalchemy as sa
from sqlalchemy.sql import table, column

def upgrade() -> None:
    # 1. Modifications de structure
    op.add_column('users', sa.Column('full_name', sa.String(200), nullable=True))
    
    # 2. Migration des donn√©es
    users_table = table('users',
        column('id', sa.Integer),
        column('first_name', sa.String),
        column('last_name', sa.String),
        column('full_name', sa.String)
    )
    
    # Concat√©ner first_name et last_name en full_name
    connection = op.get_bind()
    connection.execute(
        users_table.update().values(
            full_name=sa.func.concat(users_table.c.first_name, ' ', users_table.c.last_name)
        )
    )
    
    # 3. Suppression des anciennes colonnes
    op.drop_column('users', 'first_name')
    op.drop_column('users', 'last_name')
```

## üêõ D√©pannage

### Erreur "Target database is not up to date"

```bash
# Marquer la DB comme √©tant √† jour sans appliquer les migrations
poetry run alembic stamp head
```

### Conflit de migration

```bash
# Voir les branches
poetry run alembic branches

# Fusionner les branches
poetry run alembic merge -m "Merge branches" rev1 rev2
```

### Reset complet (d√©veloppement uniquement)

```bash
# Supprimer toutes les tables
# Supprimer la table alembic_version
# Recr√©er la structure
poetry run python app/db/init_db.py
poetry run alembic stamp head
```

## üìö Ressources

- [Documentation officielle Alembic](https://alembic.sqlalchemy.org/)
- [Cookbook Alembic](https://alembic.sqlalchemy.org/en/latest/cookbook.html)
- [Auto-generating migrations](https://alembic.sqlalchemy.org/en/latest/autogenerate.html)

---

**Note** : Les migrations sont versionn√©es et permettent un d√©ploiement coh√©rent entre d√©veloppement, staging et production. Toujours tester les migrations sur un environnement de staging avant la production !